<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenSeadragon Complete Feature Viewer</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            overflow: hidden;
        }

        /* Layout Structure */
        .container {
            display: flex;
            height: 100vh;
        }

        /* Control Panel */
        .control-panel {
            width: 320px;
            background: #2a2a2a;
            border-right: 1px solid #444;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            transition: transform 0.3s ease;
        }

        .control-panel.collapsed {
            transform: translateX(-320px);
        }

        .control-section {
            background: #333;
            border-radius: 8px;
            padding: 15px;
        }

        .control-section h3 {
            margin-bottom: 15px;
            color: #4CAF50;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Form Controls */
        .control-group {
            margin-bottom: 12px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            color: #b0b0b0;
        }

        .control-group input[type="text"],
        .control-group input[type="number"],
        .control-group select,
        .control-group textarea {
            width: 100%;
            padding: 8px;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 13px;
        }

        .control-group input[type="checkbox"] {
            margin-right: 8px;
        }

        .control-group input[type="range"] {
            width: 100%;
        }

        .btn {
            display: inline-block;
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            margin: 4px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #45a049;
        }

        .btn.btn-secondary {
            background: #555;
        }

        .btn.btn-secondary:hover {
            background: #666;
        }

        .btn.btn-danger {
            background: #f44336;
        }

        .btn.btn-danger:hover {
            background: #da190b;
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        /* Viewer Container */
        .viewer-container {
            flex: 1;
            position: relative;
            background: #0a0a0a;
        }

        #openseadragon-viewer {
            width: 100%;
            height: 100%;
        }

        /* Custom Toolbar */
        .custom-toolbar {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .toolbar-btn {
            width: 36px;
            height: 36px;
            background: #333;
            border: 1px solid #555;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .toolbar-btn:hover {
            background: #555;
        }

        /* Navigator Container */
        #navigator-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            border: 2px solid #4CAF50;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        /* Reference Strip Container */
        #reference-strip-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 120px;
            background: rgba(0, 0, 0, 0.8);
            border-top: 1px solid #444;
        }

        /* Overlay Styles */
        .overlay-element {
            background: rgba(76, 175, 80, 0.3);
            border: 2px solid #4CAF50;
            color: white;
            padding: 10px;
            font-size: 14px;
            pointer-events: auto;
            cursor: pointer;
        }

        .overlay-element:hover {
            background: rgba(76, 175, 80, 0.5);
        }

        /* Info Panel */
        .info-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            max-width: 300px;
            z-index: 1000;
        }

        .info-panel h4 {
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .info-item {
            margin-bottom: 5px;
        }

        .info-item span {
            color: #4CAF50;
        }

        /* Toggle Button */
        .toggle-panel {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: #333;
            padding: 10px 5px;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
            z-index: 1001;
            transition: left 0.3s ease;
        }

        .toggle-panel.shifted {
            left: 320px;
        }

        /* Keyboard Shortcuts Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            color: #4CAF50;
            margin-bottom: 20px;
        }

        .shortcuts-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 10px;
        }

        .shortcut-key {
            background: #333;
            padding: 5px 10px;
            border-radius: 4px;
            font-family: monospace;
            text-align: center;
        }

        /* Loading Indicator */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #4CAF50;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Control Panel -->
        <div class="control-panel" id="controlPanel">
            <!-- Data Sources Section -->
            <div class="control-section">
                <h3>Data Sources</h3>
                
                <div class="control-group">
                    <label>Tile Source Type</label>
                    <select id="tileSourceType">
                        <option value="dzi">DZI (Deep Zoom Image)</option>
                        <option value="iiif">IIIF</option>
                        <option value="tms">TMS</option>
                        <option value="osm">OpenStreetMap</option>
                        <option value="zoomify">Zoomify</option>
                        <option value="legacy">Legacy Image Pyramid</option>
                        <option value="image">Simple Image</option>
                        <option value="custom">Custom Tile Source</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Source URL/Config</label>
                    <textarea id="sourceConfig" rows="3" placeholder="Enter URL or JSON config..."></textarea>
                </div>

                <div class="btn-group">
                    <button class="btn" onclick="loadTileSource()">Load Source</button>
                    <button class="btn btn-secondary" onclick="loadSampleImage('dzi')">Sample DZI</button>
                    <button class="btn btn-secondary" onclick="loadSampleImage('iiif')">Sample IIIF</button>
                </div>
            </div>

            <!-- Viewer Options Section -->
            <div class="control-section">
                <h3>Viewer Options</h3>
                
                <div class="control-group">
                    <label>
                        <input type="checkbox" id="debugMode" onchange="updateViewerOption('debugMode', this.checked)">
                        Debug Mode
                    </label>
                </div>

                <div class="control-group">
                    <label>
                        <input type="checkbox" id="showNavigator" onchange="updateViewerOption('showNavigator', this.checked)" checked>
                        Show Navigator
                    </label>
                </div>

                <div class="control-group">
                    <label>
                        <input type="checkbox" id="showNavigationControl" onchange="updateViewerOption('showNavigationControl', this.checked)" checked>
                        Show Navigation Controls
                    </label>
                </div>

                <div class="control-group">
                    <label>
                        <input type="checkbox" id="sequenceMode" onchange="updateViewerOption('sequenceMode', this.checked)">
                        Sequence Mode
                    </label>
                </div>

                <div class="control-group">
                    <label>
                        <input type="checkbox" id="showReferenceStrip" onchange="updateViewerOption('showReferenceStrip', this.checked)">
                        Show Reference Strip
                    </label>
                </div>

                <div class="control-group">
                    <label>
                        <input type="checkbox" id="showRotationControl" onchange="updateViewerOption('showRotationControl', this.checked)">
                        Show Rotation Control
                    </label>
                </div>

                <div class="control-group">
                    <label>
                        <input type="checkbox" id="showFlipControl" onchange="updateViewerOption('showFlipControl', this.checked)">
                        Show Flip Control
                    </label>
                </div>

                <div class="control-group">
                    <label>Drawer Type</label>
                    <select id="drawerType" onchange="updateDrawer(this.value)">
                        <option value="webgl">WebGL</option>
                        <option value="canvas">Canvas</option>
                        <option value="html">HTML</option>
                    </select>
                </div>
            </div>

            <!-- Navigation Section -->
            <div class="control-section">
                <h3>Navigation</h3>
                
                <div class="control-group">
                    <label>Zoom Level: <span id="zoomValue">1</span></label>
                    <input type="range" id="zoomSlider" min="0.1" max="10" step="0.1" value="1" onchange="setZoom(this.value)">
                </div>

                <div class="control-group">
                    <label>Rotation: <span id="rotationValue">0¬∞</span></label>
                    <input type="range" id="rotationSlider" min="0" max="360" step="15" value="0" onchange="setRotation(this.value)">
                </div>

                <div class="btn-group">
                    <button class="btn" onclick="viewer.viewport.goHome()">Home</button>
                    <button class="btn" onclick="viewer.viewport.zoomBy(1.5)">Zoom In</button>
                    <button class="btn" onclick="viewer.viewport.zoomBy(0.75)">Zoom Out</button>
                    <button class="btn" onclick="viewer.viewport.setRotation(viewer.viewport.getRotation() + 90)">Rotate 90¬∞</button>
                    <button class="btn" onclick="viewer.viewport.setFlip(!viewer.viewport.getFlip())">Flip</button>
                </div>
            </div>

            <!-- Multi-Image Section -->
            <div class="control-section">
                <h3>Multi-Image / World</h3>
                
                <div class="control-group">
                    <label>Add Image URL</label>
                    <input type="text" id="additionalImageUrl" placeholder="Enter image URL...">
                </div>

                <div class="btn-group">
                    <button class="btn" onclick="addImage()">Add Image</button>
                    <button class="btn btn-secondary" onclick="arrangeImages('grid')">Arrange Grid</button>
                    <button class="btn btn-secondary" onclick="arrangeImages('line')">Arrange Line</button>
                    <button class="btn btn-danger" onclick="removeAllImages()">Clear All</button>
                </div>

                <div class="control-group">
                    <label>Active Image Index</label>
                    <select id="activeImageIndex" onchange="setActiveImage(this.value)">
                        <option value="0">Image 0</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Image Opacity: <span id="opacityValue">1</span></label>
                    <input type="range" id="opacitySlider" min="0" max="1" step="0.1" value="1" onchange="setImageOpacity(this.value)">
                </div>
            </div>

            <!-- Overlays Section -->
            <div class="control-section">
                <h3>Overlays</h3>
                
                <div class="control-group">
                    <label>Overlay Text</label>
                    <input type="text" id="overlayText" placeholder="Enter overlay text...">
                </div>

                <div class="control-group">
                    <label>X Position</label>
                    <input type="number" id="overlayX" min="0" max="1" step="0.1" value="0.5">
                </div>

                <div class="control-group">
                    <label>Y Position</label>
                    <input type="number" id="overlayY" min="0" max="1" step="0.1" value="0.5">
                </div>

                <div class="control-group">
                    <label>Rotation Mode</label>
                    <select id="overlayRotationMode">
                        <option value="NO_ROTATION">No Rotation</option>
                        <option value="EXACT">Exact</option>
                        <option value="BOUNDING_BOX">Bounding Box</option>
                    </select>
                </div>

                <div class="btn-group">
                    <button class="btn" onclick="addOverlay()">Add Overlay</button>
                    <button class="btn btn-danger" onclick="clearOverlays()">Clear Overlays</button>
                </div>
            </div>

            <!-- Viewport Constraints Section -->
            <div class="control-section">
                <h3>Viewport Constraints</h3>
                
                <div class="control-group">
                    <label>Min Zoom Level</label>
                    <input type="number" id="minZoomLevel" min="0" step="0.1" value="0.5" onchange="updateConstraints()">
                </div>

                <div class="control-group">
                    <label>Max Zoom Level</label>
                    <input type="number" id="maxZoomLevel" min="0" step="0.5" value="10" onchange="updateConstraints()">
                </div>

                <div class="control-group">
                    <label>
                        <input type="checkbox" id="constrainDuringPan" onchange="updateConstraints()">
                        Constrain During Pan
                    </label>
                </div>

                <div class="control-group">
                    <label>
                        <input type="checkbox" id="wrapHorizontal" onchange="updateConstraints()">
                        Wrap Horizontal
                    </label>
                </div>

                <div class="control-group">
                    <label>
                        <input type="checkbox" id="wrapVertical" onchange="updateConstraints()">
                        Wrap Vertical
                    </label>
                </div>

                <div class="control-group">
                    <label>Visibility Ratio: <span id="visibilityRatioValue">0.5</span></label>
                    <input type="range" id="visibilityRatio" min="0" max="1" step="0.1" value="0.5" onchange="updateConstraints()">
                </div>
            </div>

            <!-- Events Monitor Section -->
            <div class="control-section">
                <h3>Events Monitor</h3>
                
                <div class="control-group">
                    <label>
                        <input type="checkbox" id="monitorEvents" onchange="toggleEventMonitoring(this.checked)">
                        Monitor Events
                    </label>
                </div>

                <div id="eventLog" style="max-height: 150px; overflow-y: auto; background: #1a1a1a; padding: 10px; border-radius: 4px; font-size: 11px; font-family: monospace;">
                    <!-- Event logs will appear here -->
                </div>
            </div>

            <!-- Actions Section -->
            <div class="control-section">
                <h3>Actions</h3>
                
                <div class="btn-group">
                    <button class="btn" onclick="takeScreenshot()">üì∏ Screenshot</button>
                    <button class="btn" onclick="toggleFullPage()">‚õ∂ Full Page</button>
                    <button class="btn" onclick="showKeyboardShortcuts()">‚å®Ô∏è Shortcuts</button>
                    <button class="btn btn-secondary" onclick="exportViewerState()">üíæ Export State</button>
                    <button class="btn btn-secondary" onclick="importViewerState()">üìÇ Import State</button>
                </div>
            </div>
        </div>

        <!-- Toggle Panel Button -->
        <div class="toggle-panel shifted" id="togglePanel" onclick="toggleControlPanel()">
            <span id="toggleIcon">‚óÄ</span>
        </div>

        <!-- Viewer Container -->
        <div class="viewer-container">
            <div class="loading" id="loadingIndicator" style="display: none;">Loading...</div>
            
            <!-- Custom Toolbar -->
            <div class="custom-toolbar" id="customToolbar" style="display: none;">
                <button class="toolbar-btn" onclick="viewer.viewport.zoomBy(1.5)" title="Zoom In">+</button>
                <button class="toolbar-btn" onclick="viewer.viewport.zoomBy(0.75)" title="Zoom Out">‚àí</button>
                <button class="toolbar-btn" onclick="viewer.viewport.goHome()" title="Home">‚åÇ</button>
                <button class="toolbar-btn" onclick="viewer.viewport.setRotation(viewer.viewport.getRotation() + 90)" title="Rotate">‚Üª</button>
                <button class="toolbar-btn" onclick="viewer.viewport.setFlip(!viewer.viewport.getFlip())" title="Flip">‚áÑ</button>
                <button class="toolbar-btn" onclick="toggleFullPage()" title="Full Page">‚õ∂</button>
            </div>

            <!-- Info Panel -->
            <div class="info-panel" id="infoPanel">
                <h4>Viewer Info</h4>
                <div class="info-item">Zoom: <span id="info-zoom">1.00x</span></div>
                <div class="info-item">Center: <span id="info-center">0.5, 0.5</span></div>
                <div class="info-item">Rotation: <span id="info-rotation">0¬∞</span></div>
                <div class="info-item">Images: <span id="info-images">0</span></div>
                <div class="info-item">Mouse: <span id="info-mouse">-, -</span></div>
            </div>

            <!-- Navigator Container -->
            <div id="navigator-container" style="display: none;"></div>

            <!-- Reference Strip Container -->
            <div id="reference-strip-container" style="display: none;"></div>

            <!-- Main Viewer -->
            <div id="openseadragon-viewer"></div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div class="modal" id="shortcutsModal" onclick="if(event.target === this) this.style.display='none'">
        <div class="modal-content">
            <h2>Keyboard Shortcuts</h2>
            <div class="shortcuts-grid">
                <div class="shortcut-key">W / ‚Üë</div><div>Move up</div>
                <div class="shortcut-key">S / ‚Üì</div><div>Move down</div>
                <div class="shortcut-key">A / ‚Üê</div><div>Move left</div>
                <div class="shortcut-key">D / ‚Üí</div><div>Move right</div>
                <div class="shortcut-key">0</div><div>Go home</div>
                <div class="shortcut-key">- / _</div><div>Zoom out</div>
                <div class="shortcut-key">= / +</div><div>Zoom in</div>
                <div class="shortcut-key">R</div><div>Rotate clockwise</div>
                <div class="shortcut-key">Shift+R</div><div>Rotate counter-clockwise</div>
                <div class="shortcut-key">F</div><div>Flip horizontally</div>
                <div class="shortcut-key">J</div><div>Previous image (sequence mode)</div>
                <div class="shortcut-key">K</div><div>Next image (sequence mode)</div>
                <div class="shortcut-key">ESC</div><div>Exit full page</div>
            </div>
            <button class="btn" style="margin-top: 20px;" onclick="document.getElementById('shortcutsModal').style.display='none'">Close</button>
        </div>
    </div>

    <!-- OpenSeadragon Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/openseadragon.min.js"></script>
    
    <!-- Main Application Script -->
    <script>
        // Global viewer instance
        let viewer;
        let eventMonitoringEnabled = false;
        let overlayIdCounter = 0;

        // Sample tile sources
        const sampleSources = {
            dzi: {
                Image: {
                    xmlns: "http://schemas.microsoft.com/deepzoom/2008",
                    Url: "https://openseadragon.github.io/example-images/highsmith/highsmith_files/",
                    Format: "jpg",
                    Overlap: "2",
                    TileSize: "256",
                    Size: {
                        Height: "9221",
                        Width: "7026"
                    }
                }
            },
            iiif: "https://iiif.wellcomecollection.org/image/V0029599.jpg/info.json"
        };

        // Initialize viewer with all features
        function initializeViewer() {
            viewer = OpenSeadragon({
                id: "openseadragon-viewer",
                prefixUrl: "https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/images/",
                
                // Basic options
                visibilityRatio: 0.5,
                minZoomLevel: 0.5,
                maxZoomLevel: 10,
                defaultZoomLevel: 1,
                
                // Navigation options
                showNavigator: true,
                navigatorId: "navigator-container",
                navigatorAutoResize: true,
                navigatorAutoFade: false,
                navigatorRotate: true,
                
                // Controls
                showNavigationControl: true,
                navigationControlAnchor: OpenSeadragon.ControlAnchor.TOP_LEFT,
                showZoomControl: true,
                showHomeControl: true,
                showFullPageControl: true,
                showRotationControl: false,
                showFlipControl: false,
                
                // Sequence mode options
                sequenceMode: false,
                showReferenceStrip: false,
                referenceStripId: "reference-strip-container",
                referenceStripScroll: 'horizontal',
                referenceStripHeight: 120,
                referenceStripSizeRatio: 0.2,
                showSequenceControl: true,
                
                // Interaction options
                gestureSettingsMouse: {
                    clickToZoom: true,
                    dblClickToZoom: true,
                    pinchToZoom: true,
                    flickEnabled: true,
                    flickMinSpeed: 120,
                    flickMomentum: 0.25,
                    pinchRotate: false
                },
                
                // Performance options
                immediateRender: false,
                preserveViewport: false,
                preserveOverlays: false,
                blendTime: 0.5,
                alwaysBlend: false,
                
                // Debug options
                debugMode: false,
                debugGridColor: ['#437AB2', '#1B9E77', '#D95F02', '#7570B3'],
                
                // Drawer options
                drawer: ['webgl', 'canvas', 'html'],
                
                // Toolbar
                toolbar: "customToolbar",
                
                // Other options
                autoHideControls: true,
                controlsFadeDelay: 2000,
                controlsFadeLength: 1500,
                mouseNavEnabled: true,
                constrainDuringPan: false,
                wrapHorizontal: false,
                wrapVertical: false,
                panHorizontal: true,
                panVertical: true,
                minPixelRatio: 0.5,
                smoothTileEdgesMinZoom: 1.1,
                iOSDevice: /iPad|iPhone|iPod/.test(navigator.userAgent),
                autoResize: true,
                preserveImageSizeOnResize: false,
                pixelsPerWheelLine: 40,
                pixelsPerArrowPress: 40,
                timeout: 30000,
                tileRetryMax: 0,
                tileRetryDelay: 2500,
                maxImageCacheCount: 200,
                imageLoaderLimit: 0,
                clickTimeThreshold: 300,
                clickDistThreshold: 5,
                dblClickTimeThreshold: 300,
                dblClickDistThreshold: 20,
                springStiffness: 6.5,
                animationTime: 1.2,
                minScrollDeltaTime: 50,
                rotationIncrement: 90,
                maxTilesPerFrame: 1,
                homeFillsViewer: false,
                collectionMode: false,
                collectionRows: 3,
                collectionColumns: 0,
                collectionLayout: 'horizontal',
                collectionTileSize: 800,
                collectionTileMargin: 80,
                crossOriginPolicy: 'Anonymous',
                ajaxWithCredentials: false,
                loadTilesWithAjax: false,
                ajaxHeaders: {},
                splitHashDataForPost: false
            });

            // Add event handlers
            setupEventHandlers();
            
            // Load initial sample image
            loadSampleImage('dzi');
            
            // Update UI
            updateUIState();
        }

        // Setup all event handlers
        function setupEventHandlers() {
            // Viewport change events
            viewer.addHandler('viewport-change', function(event) {
                updateInfoPanel();
                updateSliders();
            });

            // Animation events
            viewer.addHandler('animation', function(event) {
                updateInfoPanel();
            });

            // Open events
            viewer.addHandler('open', function(event) {
                updateImageSelector();
                logEvent('open', 'Image opened');
            });

            // Tile events
            viewer.addHandler('tile-loaded', function(event) {
                logEvent('tile-loaded', `Tile loaded at level ${event.tile.level}`);
            });

            viewer.addHandler('tile-load-failed', function(event) {
                logEvent('tile-load-failed', `Failed to load tile: ${event.message}`);
            });

            // Mouse tracking
            new OpenSeadragon.MouseTracker({
                element: viewer.canvas,
                moveHandler: function(event) {
                    if (viewer.viewport) {
                        const viewportPoint = viewer.viewport.pointFromPixel(event.position);
                        document.getElementById('info-mouse').textContent = 
                            `${viewportPoint.x.toFixed(3)}, ${viewportPoint.y.toFixed(3)}`;
                    }
                }
            });

            // Full page events
            viewer.addHandler('full-page', function(event) {
                logEvent('full-page', event.fullPage ? 'Entered full page' : 'Exited full page');
            });

            // World events
            viewer.world.addHandler('add-item', function(event) {
                updateImageSelector();
                logEvent('add-item', 'Image added to world');
            });

            viewer.world.addHandler('remove-item', function(event) {
                updateImageSelector();
                logEvent('remove-item', 'Image removed from world');
            });

            // Keyboard focus for navigation
            viewer.canvas.tabIndex = 0;
            viewer.canvas.focus();
        }

        // Load tile source based on type and config
        function loadTileSource() {
            const type = document.getElementById('tileSourceType').value;
            const config = document.getElementById('sourceConfig').value.trim();
            
            if (!config) {
                alert('Please enter a tile source configuration');
                return;
            }

            let tileSource;
            
            try {
                switch (type) {
                    case 'dzi':
                    case 'iiif':
                    case 'custom':
                        // Try to parse as JSON first
                        try {
                            tileSource = JSON.parse(config);
                        } catch (e) {
                            // If not JSON, treat as URL
                            tileSource = config;
                        }
                        break;
                    
                    case 'tms':
                        tileSource = {
                            type: 'tiledmapservice',
                            tilesUrl: config,
                            width: 256 * Math.pow(2, 10),
                            height: 256 * Math.pow(2, 10)
                        };
                        break;
                    
                    case 'osm':
                        tileSource = {
                            type: 'openstreetmaps'
                        };
                        break;
                    
                    case 'zoomify':
                        tileSource = {
                            type: 'zoomifytileservice',
                            tilesUrl: config
                        };
                        break;
                    
                    case 'legacy':
                        tileSource = JSON.parse(config);
                        tileSource.type = 'legacy-image-pyramid';
                        break;
                    
                    case 'image':
                        tileSource = {
                            type: 'image',
                            url: config
                        };
                        break;
                }
                
                showLoading(true);
                viewer.open(tileSource);
                
            } catch (error) {
                alert('Error loading tile source: ' + error.message);
                console.error(error);
            } finally {
                showLoading(false);
            }
        }

        // Load sample images
        function loadSampleImage(type) {
            const source = sampleSources[type];
            if (source) {
                document.getElementById('sourceConfig').value = 
                    typeof source === 'string' ? source : JSON.stringify(source, null, 2);
                document.getElementById('tileSourceType').value = type;
                loadTileSource();
            }
        }

        // Update viewer option
        function updateViewerOption(option, value) {
            switch (option) {
                case 'debugMode':
                    viewer.debugMode = value;
                    viewer.forceRedraw();
                    break;
                
                case 'showNavigator':
                    viewer.navigator.element.style.display = value ? 'block' : 'none';
                    break;
                
                case 'showNavigationControl':
                    viewer.showNavigationControl = value;
                    viewer.setControlsEnabled(value);
                    break;
                
                case 'sequenceMode':
                    if (value) {
                        // Need to reload with sequence mode
                        alert('Sequence mode requires reloading with multiple images');
                    }
                    break;
                
                case 'showReferenceStrip':
                    if (viewer.referenceStrip) {
                        viewer.referenceStrip.element.style.display = value ? 'block' : 'none';
                    }
                    break;
                
                case 'showRotationControl':
                case 'showFlipControl':
                    // These require viewer recreation
                    alert('This option requires recreating the viewer');
                    break;
            }
        }

        // Update drawer type
        function updateDrawer(drawerType) {
            alert('Changing drawer requires recreating the viewer');
            // In a real implementation, you would recreate the viewer with the new drawer
        }

        // Navigation functions
        function setZoom(value) {
            viewer.viewport.zoomTo(parseFloat(value));
            document.getElementById('zoomValue').textContent = value;
        }

        function setRotation(value) {
            viewer.viewport.setRotation(parseFloat(value));
            document.getElementById('rotationValue').textContent = value + '¬∞';
        }

        // Multi-image functions
        function addImage() {
            const url = document.getElementById('additionalImageUrl').value.trim();
            if (!url) {
                alert('Please enter an image URL');
                return;
            }

            viewer.addTiledImage({
                tileSource: url,
                index: viewer.world.getItemCount(),
                success: function(event) {
                    logEvent('add-image-success', 'Additional image added successfully');
                    document.getElementById('additionalImageUrl').value = '';
                }
            });
        }

        function arrangeImages(layout) {
            const count = viewer.world.getItemCount();
            if (count === 0) return;

            const bounds = viewer.viewport.getBounds();
            const aspectRatio = bounds.getAspectRatio();
            
            if (layout === 'grid') {
                const cols = Math.ceil(Math.sqrt(count));
                const rows = Math.ceil(count / cols);
                const cellWidth = 1 / cols;
                const cellHeight = cellWidth * aspectRatio;
                
                for (let i = 0; i < count; i++) {
                    const row = Math.floor(i / cols);
                    const col = i % cols;
                    const image = viewer.world.getItemAt(i);
                    
                    image.setPosition(new OpenSeadragon.Point(col * cellWidth, row * cellHeight));
                    image.setWidth(cellWidth * 0.9);
                }
            } else if (layout === 'line') {
                const cellWidth = 1 / count;
                
                for (let i = 0; i < count; i++) {
                    const image = viewer.world.getItemAt(i);
                    image.setPosition(new OpenSeadragon.Point(i * cellWidth, 0));
                    image.setWidth(cellWidth * 0.9);
                }
            }
            
            viewer.viewport.goHome();
        }

        function removeAllImages() {
            viewer.world.removeAll();
        }

        function setActiveImage(index) {
            const item = viewer.world.getItemAt(parseInt(index));
            if (item) {
                viewer.viewport.fitBounds(item.getBounds());
            }
        }

        function setImageOpacity(value) {
            const index = parseInt(document.getElementById('activeImageIndex').value);
            const item = viewer.world.getItemAt(index);
            if (item) {
                item.setOpacity(parseFloat(value));
                document.getElementById('opacityValue').textContent = value;
            }
        }

        // Overlay functions
        function addOverlay() {
            const text = document.getElementById('overlayText').value || 'Overlay ' + (++overlayIdCounter);
            const x = parseFloat(document.getElementById('overlayX').value);
            const y = parseFloat(document.getElementById('overlayY').value);
            const rotationMode = document.getElementById('overlayRotationMode').value;
            
            const element = document.createElement('div');
            element.className = 'overlay-element';
            element.innerHTML = text;
            element.id = 'overlay-' + overlayIdCounter;
            
            viewer.addOverlay({
                element: element,
                location: new OpenSeadragon.Point(x, y),
                placement: OpenSeadragon.Placement.CENTER,
                rotationMode: OpenSeadragon.OverlayRotationMode[rotationMode]
            });
            
            // Add click handler
            new OpenSeadragon.MouseTracker({
                element: element,
                clickHandler: function(event) {
                    alert('Overlay clicked: ' + text);
                }
            });
            
            logEvent('add-overlay', `Overlay added at (${x}, ${y})`);
        }

        function clearOverlays() {
            viewer.clearOverlays();
            overlayIdCounter = 0;
            logEvent('clear-overlays', 'All overlays cleared');
        }

        // Viewport constraint functions
        function updateConstraints() {
            const minZoom = parseFloat(document.getElementById('minZoomLevel').value);
            const maxZoom = parseFloat(document.getElementById('maxZoomLevel').value);
            const visibilityRatio = parseFloat(document.getElementById('visibilityRatio').value);
            const constrainDuringPan = document.getElementById('constrainDuringPan').checked;
            const wrapHorizontal = document.getElementById('wrapHorizontal').checked;
            const wrapVertical = document.getElementById('wrapVertical').checked;
            
            viewer.viewport.minZoomLevel = minZoom;
            viewer.viewport.maxZoomLevel = maxZoom;
            viewer.viewport.visibilityRatio = visibilityRatio;
            viewer.viewport.constrainDuringPan = constrainDuringPan;
            viewer.viewport.wrapHorizontal = wrapHorizontal;
            viewer.viewport.wrapVertical = wrapVertical;
            
            document.getElementById('visibilityRatioValue').textContent = visibilityRatio;
        }

        // Event monitoring
        function toggleEventMonitoring(enabled) {
            eventMonitoringEnabled = enabled;
            if (!enabled) {
                document.getElementById('eventLog').innerHTML = '';
            }
        }

        function logEvent(eventName, details) {
            if (!eventMonitoringEnabled) return;
            
            const log = document.getElementById('eventLog');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.style.marginBottom = '4px';
            entry.innerHTML = `<span style="color: #4CAF50">[${timestamp}]</span> ${eventName}: ${details}`;
            
            log.insertBefore(entry, log.firstChild);
            
            // Keep only last 20 events
            while (log.children.length > 20) {
                log.removeChild(log.lastChild);
            }
        }

        // Screenshot function
        function takeScreenshot() {
            if (!viewer.drawer || !viewer.drawer.canvas) {
                alert('No canvas available for screenshot');
                return;
            }

            const canvas = viewer.drawer.canvas;
            canvas.toBlob(function(blob) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'openseadragon-screenshot-' + Date.now() + '.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                logEvent('screenshot', 'Screenshot saved');
            });
        }

        // Full page toggle
        function toggleFullPage() {
            viewer.setFullScreen(!viewer.isFullPage());
        }

        // Export/Import viewer state
        function exportViewerState() {
            const state = {
                viewport: {
                    center: viewer.viewport.getCenter(),
                    zoom: viewer.viewport.getZoom(),
                    rotation: viewer.viewport.getRotation(),
                    flip: viewer.viewport.getFlip()
                },
                images: [],
                overlays: []
            };
            
            // Save image states
            for (let i = 0; i < viewer.world.getItemCount(); i++) {
                const item = viewer.world.getItemAt(i);
                state.images.push({
                    source: item.source,
                    position: item.getPosition(),
                    width: item.getWidth(),
                    opacity: item.getOpacity()
                });
            }
            
            const stateJson = JSON.stringify(state, null, 2);
            const blob = new Blob([stateJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'viewer-state-' + Date.now() + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            logEvent('export-state', 'Viewer state exported');
        }

        function importViewerState() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const state = JSON.parse(e.target.result);
                        
                        // Apply viewport state
                        if (state.viewport) {
                            viewer.viewport.zoomTo(state.viewport.zoom);
                            viewer.viewport.panTo(state.viewport.center);
                            viewer.viewport.setRotation(state.viewport.rotation);
                            if (state.viewport.flip) {
                                viewer.viewport.setFlip(state.viewport.flip);
                            }
                        }
                        
                        logEvent('import-state', 'Viewer state imported');
                    } catch (error) {
                        alert('Error importing state: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // UI Helper functions
        function toggleControlPanel() {
            const panel = document.getElementById('controlPanel');
            const toggle = document.getElementById('togglePanel');
            const icon = document.getElementById('toggleIcon');
            
            panel.classList.toggle('collapsed');
            toggle.classList.toggle('shifted');
            icon.textContent = panel.classList.contains('collapsed') ? '‚ñ∂' : '‚óÄ';
        }

        function showKeyboardShortcuts() {
            document.getElementById('shortcutsModal').style.display = 'flex';
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
        }

        function updateInfoPanel() {
            if (!viewer.viewport) return;
            
            const zoom = viewer.viewport.getZoom();
            const center = viewer.viewport.getCenter();
            const rotation = viewer.viewport.getRotation();
            const imageCount = viewer.world.getItemCount();
            
            document.getElementById('info-zoom').textContent = zoom.toFixed(2) + 'x';
            document.getElementById('info-center').textContent = 
                `${center.x.toFixed(3)}, ${center.y.toFixed(3)}`;
            document.getElementById('info-rotation').textContent = rotation.toFixed(0) + '¬∞';
            document.getElementById('info-images').textContent = imageCount;
        }

        function updateSliders() {
            if (!viewer.viewport) return;
            
            const zoom = viewer.viewport.getZoom();
            const rotation = viewer.viewport.getRotation();
            
            document.getElementById('zoomSlider').value = zoom;
            document.getElementById('zoomValue').textContent = zoom.toFixed(2);
            document.getElementById('rotationSlider').value = rotation;
            document.getElementById('rotationValue').textContent = rotation.toFixed(0) + '¬∞';
        }

        function updateImageSelector() {
            const selector = document.getElementById('activeImageIndex');
            const count = viewer.world.getItemCount();
            
            selector.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Image ${i}`;
                selector.appendChild(option);
            }
        }

        function updateUIState() {
            // Update checkboxes based on viewer state
            document.getElementById('debugMode').checked = viewer.debugMode;
            document.getElementById('showNavigator').checked = viewer.navigator.element.style.display !== 'none';
            document.getElementById('showNavigationControl').checked = viewer.showNavigationControl;
            
            // Show/hide UI elements based on state
            document.getElementById('customToolbar').style.display = 'flex';
            if (viewer.navigator) {
                document.getElementById('navigator-container').style.display = 'block';
            }
        }

        // Initialize the viewer when page loads
        window.addEventListener('DOMContentLoaded', initializeViewer);

        // Handle window resize
        window.addEventListener('resize', function() {
            if (viewer) {
                viewer.viewport.resize();
                viewer.viewport.goHome(true);
            }
        });
    </script>
</body>
</html>