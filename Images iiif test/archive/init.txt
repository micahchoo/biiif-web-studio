(function() {
    function setPosterAndLang() {
        var h = paramsToHash(window.location.search);
        beehive_poster = h.poster;
        beehive_lang = (typeof h.lang === "undefined") ? 'en' : h.lang;
    }

    function setupOpenSeadragonViewer() {
        var dziFile = "./tiles/" + beehive_poster + "/" + beehive_poster + ".dzi";
        window.openSeadragonViewer = OpenSeadragon({
            id: "openseadragon",
            showNavigator: false,
            autoHideControls: false,
            prefixUrl: "./openseadragon-bin-2.3.0/images/",
            tileSources: dziFile,
            zoomInButton: 'zoomInBtn',
            zoomOutButton: 'zoomOutBtn',
            homeButton: 'fullPosterBtn',
            minZoomImageRatio: 0.7
        });
    }

    function addControls() {
        var controls = $("#overlayControls");
        var navControls = $("#navControls");
        var minimizedButton = $("#showControlsBtn");
        var container = $("#openseadragon .openseadragon-container");

        $("body").on("click", "#fullPageBtn, #fullScreenInstruction", function(event) {
            event.preventDefault();
            if (OpenSeadragon.isFullScreen()) {
                OpenSeadragon.exitFullScreen();
            } else {
                OpenSeadragon.requestFullScreen(document.body);
            }
            adjustTipVisibility($(".controlsText").data("beehive-story-li"));
        });

        if ((!OpenSeadragon.supportsFullScreen) && (!OpenSeadragon.isFullScreen())) {
            $("#fullPageBtn").css("visibility", "hidden");
        }

        controls.on("click", ".controlsMinimize", function(event) {
            event.preventDefault();
            controls.slideUp('slow', function() {
                minimizedButton.fadeIn();
            });
        });

        navControls.on("click", "#showControlsBtn", function(event) {
            event.preventDefault();
            minimizedButton.fadeOut(function() {
                storyListHeightLimit();
                controls.slideDown('slow', function() {
                    storyListHeightLimit();
                    if ($(".controlsText").is(":visible")) {
                        $(".controlsText").hide();
                        $(".controlsText").fadeIn(1);
                    }
                });
            });
        });

        $("#overlayControls").on("click", ".scene-expander", function(event) {
            event.preventDefault();
            if ($(this).hasClass("open")) {
                closeStoryList();
            } else {
                openStoryList();
            }
        });

        $("#storyList").on("click", ".story", function(event) {
            event.preventDefault();
            var li = $(this).closest("li");
            loadStory(li);
        });

        $(".controls-text-nav").on("click", ".controls-text-nav-prev", function(event) {
            event.preventDefault();
            var li = $(".controlsText").data("beehive-story-li");
            loadStory(li.prev());
        });

        $(".controls-text-nav").on("click", ".controls-text-nav-next", function(event) {
            event.preventDefault();
            var li = $(".controlsText").data("beehive-story-li");
            var nextLi;
            if (typeof li == 'undefined') {
                nextLi = $("#storyList li").first();
            } else {
                nextLi = li.next();
            }
            loadStory(nextLi);
        });
    }

    function loadPosterData() {
        var fetchUrl = "./narrative/" + beehive_poster + "/" + beehive_lang + ".xml";
        var ajax = $.ajax({
            url: fetchUrl,
            dataType: "xml",
            success: function(xml) {
                xml = $(xml);
                var title_text = xml.find("data > title").text().trim();
                var title_link = xml.find("data > link").text().trim();
                document.title = title_text;
                $("#titleLink").attr("href", title_link).html(title_text.replace(/[\n\r]+/, "<br>"));
                var storyList = $("#storyList");
                xml.find('story').each(function(i, storyXml) {
                    var storyJson = storyXmlToJson(storyXml);
                    var li = $("<li/>");
                    var a = $("<a href='#' class='story'/>")
                        .attr('href', storyToFragmentUrl(storyJson))
                        .text($(storyXml).find("label").text())
                        .data('beehive-story', storyJson);
                    li.append(a).appendTo(storyList);
                });
                if (storyList.find("li").size() > 1) {
                    $(".controls-story-list-expander").show();
                }
                storyListHeightLimit();
            }
        });
        return ajax;
    }

    function gotoInitialView() {
        var params = paramsToHash(document.location.hash.replace(/^\#/, ''));
        if (("x" in params) && (params.x !== "") &&
            ("y" in params) && (params.y !== "") &&
            ("w" in params) && (params.w !== "") &&
            ("h" in params) && (params.h !== "")) {
            var rect = new OpenSeadragon.Rect(parseFloat(params.x),
                parseFloat(params.y),
                parseFloat(params.w),
                parseFloat(params.h));
            openSeadragonViewer.viewport.fitBounds(rect);
        } else if ("s" in params) {
            var destLi = $("#storyList li").filter(function(i, li) {
                var story = $(li).find(".story").data("beehive-story");
                return story.label == params.s;
            }).first();
            if (destLi) {
                loadStory(destLi);
            }
        } else {
            var li = $("#storyList li:first");
            if (li.size() > 0) {
                loadStory(li);
            }
        }
    }

    // Export functions
    window.initFunctions = {
        setPosterAndLang,
        setupOpenSeadragonViewer,
        addControls,
        loadPosterData,
        gotoInitialView
    };
})();
