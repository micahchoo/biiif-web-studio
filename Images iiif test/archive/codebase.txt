//main.js

import * as utils from './utils.js';
import * as initFunctions from './init.js';
import * as UI from './ui.js';
import * as Story from './story.js';
import * as adminFunctions from './admin.js';
// Importing functions from different modules

// Initialize global variables
var beehive_poster;
var beehive_lang;

// Set poster and language from query params
window.initFunctions.setPosterAndLang();

// Initialize OpenSeadragon viewer
window.initFunctions.setupOpenSeadragonViewer();

// Add controls to the viewer
window.initFunctions.addControls();

// Load poster data
window.initFunctions.loadPosterData();

// Go to the initial view
window.initFunctions.gotoInitialView();

// Apply internationalization values
UI.applyI18nValues(beehive_lang);

// Adjust story list height limit
UI.storyListHeightLimit();

// Add event listeners for window resize
jQuery(document).ready(function($) {
    $(window).resize(function(event) {
        UI.storyListHeightLimit();
    });
});

// Add admin helper UI if in admin mode
if (utils.paramsToHash(document.location.search).admin === "true") {
    adminFunctions.addAdminHelperUI();
}

// Add event listeners for OpenSeadragon viewer
openSeadragonViewer.addHandler('animation-finish', function(target, info) {
    // If the animation finished after we explicitly loaded a scene,
    // do NOT re-calculate and load a DIFFERENT scene!
    if (sceneTransitionMode) {
        sceneTransitionMode = false;
        return;
    }

    var bounds = target.eventSource.viewport.getBounds();
    var bestLi = utils.calcProximateScene(utils.subtractPanelFromViewport(bounds));

    if (bestLi == null) {
        // Unload any story, but leave 'next' button.
        $(".controlsText").hide();
    } else if ($(".controlsText").data("beehive-story-li") == undefined || bestLi != $(".controlsText").data("beehive-story-li").get(0)) {
        // Load it unless it's already loaded.
        Story.loadStory(bestLi, false);
    }
});

// Add event listener for keydown events
$(document).on("keydown", function(event) {
    var x = 1;

    // Pass it to the OSD viewer
    var newEvent = jQuery.Event('keypress');
    newEvent.which = event.which;
    newEvent.keyCode = event.keyCode;
    $("#openseadragon .openseadragon-container").focus().trigger(newEvent);
});

// Exporting functions for external use
export {
    Story,
    initFunctions,
    utils,
    UI,
    adminFunctions
};


//ui.js
(function() {

// A span or other element with data-i18n-key="key"
// will have it's text content replaced by the value
// from i18n hashes above.
// data-i18n-title-key will have 'title' attribute
// replaced instead, for <a> mouseovers.

function applyI18nValues(lang) {
    $(document).find("[data-i18n-key]").each(function(i, el) {
      var key = el.attributes['data-i18n-key'].value;
      var value = i18n_data[lang][key];
      if (value) {
        $(el).text(  value  );
      }
    });
  
    $(document).find("[data-i18n-title-key]").each(function(i, el) {
      var key = el.attributes['data-i18n-title-key'].value;
      var value = i18n_data[lang][key];
      if (value) {
        $(el).attr('title',  value);
      }
    });
  }
  // Hides or shows full-screen tip depending on current
// context -- show, only on the first scene, only if
// we're not in full-screen mode, and full-screen mode is
// possible.
//
// Pass in an 'li' for a scene, so we can determine
// if it's the first scene.
function adjustTipVisibility(li) {
    // Show full screen instructions IFF it's the first element
    // and we can switch to full-screen view
    if (li.prev().size() == 0  && (OpenSeadragon.supportsFullScreen) && (! OpenSeadragon.isFullScreen())) {
      $("#fullScreenInstruction").show();
    } else {
      $("#fullScreenInstruction").hide();
    }
  }
    // Height limits on the story list we couldn't figure out
  // how to do with pure CSS, we'll use some JS that we run on
  // load and screen size change.
  function storyListHeightLimit() {
    // Need to make sure it's a container that makes it onto
    // full screen mode.
    var container = $("#openseadragon");
    var panel     = $("#overlayControls")

    var maxPanelHeight = container.height() -
      panel.position().top -
      parseInt(panel.css('margin-top')) -
      20; // 20px bottom margin we want

    panel.css("max-height", maxPanelHeight);

    // The story list and and the story text area take
    // turns being on the screen once at a time, below
    // the header area. They each need a max height
    // such that they won't overflow the panel.
    var storyListBottom =
      $(".controls-story-list-expander").position().top +
      $(".controls-story-list-expander").outerHeight(true);
    // CSS max-heigh doesn't account for padding or borders, we need
    // to subtract extra to account, we just do a healthy extra amt.
    var maxLowerHeight = maxPanelHeight - storyListBottom - 24;

    panel.find(".controls-story-list, .controlsText").each(function(i, section) {
      $(section).css("max-height", maxLowerHeight);
    });
  }
  window.UI = {
    applyI18nValues: applyI18nValues,
    adjustTipVisibility: adjustTipVisibility,
    storyListHeightLimit: storyListHeightLimit
  };
})();

//story.js

import * as utils from './utils.js';
import * as initFunctions from './init.js';

(function() {
  function loadStory(li, move = true) {
      li = $(li);
      var story = li.find(".story").data("beehive-story");
      if (typeof story === "undefined") return;
      var rect = new OpenSeadragon.Rect(parseFloat(story.region.x),
          parseFloat(story.region.y),
          parseFloat(story.region.width),
          parseFloat(story.region.height));
      $(".controlsText").data("beehive-story-li", li);
      $(".controls-text-nav-prev").css("visibility", (li.prev().size() > 0) ? "visible" : "hidden");
      $(".controls-text-nav-next").css("visibility", (li.next().size() > 0) ? "visible" : "hidden");
      UI.adjustTipVisibility(li);
      $("#storyLabel").text(story.label);
      $("#storyText").html(story.html);
      $(".controlsText").get(0).scrollTop = 0;
      $(".controlsText").slideDown('slow');
      closeStoryList(function() {
          if (move) {
              sceneTransitionMode = true;
              utils.withSlowOSDAnimation(function() {
                  rect = utils.adjustRectForPanel(rect);
                  openSeadragonViewer.viewport.fitBounds(rect);
              });
          }
      });
  }

  function closeStoryList(func) {
      if ($("#slideContainerOverlay").is(":visible")) {
          $("#slideContainerOverlay").fadeOut('slow');
      }
      $(".controls-story-list").slideUp('slow', function() {
          $(".scene-expander").removeClass("open");
          if (typeof func !== 'undefined') {
              func();
          }
          $("#sceneExpanderImg").attr("src", "./images/expand.png");
      });
  }

  function openStoryList() {
      $("#slideContainerOverlay").fadeIn('slow');
      $(".controls-story-list").slideDown('slow', function() {
          $(".scene-expander").addClass("open");
          $("#sceneExpanderImg").attr("src", "./images/collapse.png");
      });
  }

  function storyXmlToJson(storyXml) {
      storyXml = $(storyXml);
      var json = {};
      json.label = storyXml.find("label").text();
      var htmlElement = storyXml.find("html").get(0);
      var serialized = new XMLSerializer().serializeToString(htmlElement);
      if (htmlElement.childNodes.length === 1 && htmlElement.childNodes[0].nodeType === 3) {
          serialized = "<p>" + serialized + "</p>";
      }
      json.html = serialized;
      var regionXml = storyXml.find("region");
      json.region = {
          x: regionXml.attr("x"),
          y: regionXml.attr("y"),
          width: regionXml.attr("width"),
          height: regionXml.attr("height")
      };
      return json;
  }

  function storyToFragmentUrl(storyJson) {
      var label = storyJson.label;
      if ((typeof label === "undefined") || label.length === 0) {
          return;
      } else {
          return window.location.href.split('#')[0] + "#s=" + encodeURIComponent(label);
      }
  }

  // Export functions
  window.Story = {
      loadStory,
      closeStoryList,
      openStoryList,
      storyXmlToJson,
      storyToFragmentUrl
  };
})();


//init.js

import * as utils from './utils.js';
import * as Story from './story.js';
import * as UI from './ui.js';


// init.js

(function() {
    function setPosterAndLang() {
        var h = window.utils.paramsToHash(window.location.search);
        beehive_poster = h.poster;
        beehive_lang = (typeof h.lang === "undefined") ? 'en' : h.lang;
    }

    function setupOpenSeadragonViewer() {
        var dziFile = "./tiles/" + beehive_poster + "/" + beehive_poster + ".dzi";
        window.openSeadragonViewer = OpenSeadragon({
            id: "openseadragon",
            showNavigator: false,
            autoHideControls: false,
            prefixUrl: "./openseadragon-bin-2.3.0/images/",
            tileSources: dziFile,
            zoomInButton: 'zoomInBtn',
            zoomOutButton: 'zoomOutBtn',
            homeButton: 'fullPosterBtn',
            minZoomImageRatio: 0.7
        });
    }

    function addControls() {
        var controls = $("#overlayControls");
        var navControls = $("#navControls");
        var minimizedButton = $("#showControlsBtn");
        var container = $("#openseadragon .openseadragon-container");

        $("body").on("click", "#fullPageBtn, #fullScreenInstruction", function(event) {
            event.preventDefault();
            if (OpenSeadragon.isFullScreen()) {
                OpenSeadragon.exitFullScreen();
            } else {
                OpenSeadragon.requestFullScreen(document.body);
            }
            UI.adjustTipVisibility($(".controlsText").data("beehive-story-li"));
        });

        if ((!OpenSeadragon.supportsFullScreen) && (!OpenSeadragon.isFullScreen())) {
            $("#fullPageBtn").css("visibility", "hidden");
        }

        controls.on("click", ".controlsMinimize", function(event) {
            event.preventDefault();
            controls.slideUp('slow', function() {
                minimizedButton.fadeIn();
            });
        });

        navControls.on("click", "#showControlsBtn", function(event) {
            event.preventDefault();
            minimizedButton.fadeOut(function() {
                UI.storyListHeightLimit();
                controls.slideDown('slow', function() {
                    UI.storyListHeightLimit();
                    if ($(".controlsText").is(":visible")) {
                        $(".controlsText").hide();
                        $(".controlsText").fadeIn(1);
                    }
                });
            });
        });

        $("#overlayControls").on("click", ".scene-expander", function(event) {
            event.preventDefault();
            if ($(this).hasClass("open")) {
                Story.closeStoryList();
            } else {
                Story.openStoryList();
            }
        });

        $("#storyList").on("click", ".story", function(event) {
            event.preventDefault();
            var li = $(this).closest("li");
            Story.loadStory(li);
        });

        $(".controls-text-nav").on("click", ".controls-text-nav-prev", function(event) {
            event.preventDefault();
            var li = $(".controlsText").data("beehive-story-li");
            Story.loadStory(li.prev());
        });

        $(".controls-text-nav").on("click", ".controls-text-nav-next", function(event) {
            event.preventDefault();
            var li = $(".controlsText").data("beehive-story-li");
            var nextLi;
            if (typeof li == 'undefined') {
                nextLi = $("#storyList li").first();
            } else {
                nextLi = li.next();
            }
            Story.loadStory(nextLi);
        });
    }

    function loadPosterData() {
        var fetchUrl = "./narrative/" + beehive_poster + "/" + beehive_lang + ".xml";
        var ajax = $.ajax({
            url: fetchUrl,
            dataType: "xml",
            success: function(xml) {
                xml = $(xml);
                var title_text = xml.find("data > title").text().trim();
                var title_link = xml.find("data > link").text().trim();
                document.title = title_text;
                $("#titleLink").attr("href", title_link).html(title_text.replace(/[\n\r]+/, "<br>"));
                var storyList = $("#storyList");
                xml.find('story').each(function(i, storyXml) {
                    var storyJson = Story.storyXmlToJson(storyXml);
                    var li = $("<li/>");
                    var a = $("<a href='#' class='story'/>")
                        .attr('href', Story.storyToFragmentUrl(storyJson))
                        .text($(storyXml).find("label").text())
                        .data('beehive-story', storyJson);
                    li.append(a).appendTo(storyList);
                });
                if (storyList.find("li").size() > 1) {
                    $(".controls-story-list-expander").show();
                }
                UI.storyListHeightLimit();
            }
        });
        return ajax;
    }

    function gotoInitialView() {
        var params = utils.paramsToHash(document.location.hash.replace(/^\#/, ''));
        if (("x" in params) && (params.x !== "") &&
            ("y" in params) && (params.y !== "") &&
            ("w" in params) && (params.w !== "") &&
            ("h" in params) && (params.h !== "")) {
            var rect = new OpenSeadragon.Rect(parseFloat(params.x),
                parseFloat(params.y),
                parseFloat(params.w),
                parseFloat(params.h));
            openSeadragonViewer.viewport.fitBounds(rect);
        } else if ("s" in params) {
            var destLi = $("#storyList li").filter(function(i, li) {
                var story = $(li).find(".story").data("beehive-story");
                return story.label == params.s;
            }).first();
            if (destLi) {
                Story.loadStory(destLi);
            }
        } else {
            var li = $("#storyList li:first");
            if (li.size() > 0) {
                Story.loadStory(li);
            }
        }
    }

    // Export functions
    window.initFunctions = {
        setPosterAndLang,
        setupOpenSeadragonViewer,
        addControls,
        loadPosterData,
        gotoInitialView
    };
})();

//admin.js
function() {
  // Add annotorious CSS and JS (which we currently only use for admin),
  // add our custom Annotorious plugin, and show the 'define region' button
  //
  // We're currently linking to annotorious/latest on github, for some reason
  // we had trouble using a local copy.
  function addAdminHelperUI() {
    $("<link/>", {
      rel: "stylesheet",
      type: "text/css",
      href: "//annotorious.github.io/latest/annotorious.css"
    }).appendTo("head");

    $.ajax({
      url: "//annotorious.github.io/latest/annotorious.min.js",
      dataType: "script",
      success: function() {
        // Important to add the plugin BEFORE we make the OpenSeadragon viewer
        // annotatable
        addShowRegionPlugin();

        anno.makeAnnotatable(openSeadragonViewer);

        $("#map-annotate-button").show();
      }
    });

  }
  /* Used by actual on-screen annotorious make annotation stuff, which
   we're not really using at present */
function annotate() {
  var button = document.getElementById('map-annotate-button');
  button.style.color = '#777';

  anno.activateSelector(function() {
    // Reset button style
    button.style.color = '#fff';
  });
}

/* In admin mode, we use annotorious, and change it's display
   to give us the coordinates in a form we can just paste into
   a narrative.xml file */
function addShowRegionPlugin() {

  annotorious.plugin.ShowRegionPlugin = function(opt_config_options) { }

  annotorious.plugin.ShowRegionPlugin.prototype.initPlugin = function(anno) {
    // Add initialization code here, if needed (or just skip this method if not)
  }

  annotorious.plugin.ShowRegionPlugin.prototype.onInitAnnotator = function(annotator) {
    // A Field can be an HTML string or a function(annotation) that returns a string
    annotator.popup.addField(function(annotation) {
      var geometry = annotation.shapes[0].geometry;

      return '<pre>' +
        '&lt;region\n' +
        '  x="' + geometry.x.toFixed(5) +  '"\n' +
        '  y="' + geometry.y.toFixed(5) +  '"\n' +
        '  width="' + geometry.width.toFixed(5) +  '"\n' +
        '  height="' + geometry.height.toFixed(5) +  '"\n' +
        '/&gt;' +
        '</pre>';
    });
  }

  // Add the plugin like so
  anno.addPlugin('ShowRegionPlugin', {});

  
}
    // Export functions
    window.admin = {
      addAdminHelperUI,
      annotate,
      addShowRegionPlugin
  };
})();

//utils.js
(function() {
    function paramsToHash(querystring) {
        querystring = querystring.substring(querystring.indexOf('?') + 1).split('&');
        var params = {}, pair, d = decodeURIComponent;
        for (var i = querystring.length - 1; i >= 0; i--) {
            pair = querystring[i].split('=');
            params[d(pair[0])] = d(pair[1]);
        }
        return params;
    }
    console.log('paramsToHash:', paramsToHash);

    function withSlowOSDAnimation(f) {
        var viewport = openSeadragonViewer.viewport;
        var oldValues = {
            centerSpringXAnimationTime: viewport.centerSpringX.animationTime,
            centerSpringYAnimationTime: viewport.centerSpringY.animationTime,
            zoomSpringAnimationTime: viewport.zoomSpring.animationTime
        };
        viewport.centerSpringX.animationTime =
            viewport.centerSpringY.animationTime =
            viewport.zoomSpring.animationTime = 6;
        f();
        viewport.centerSpringX.animationTime = oldValues.centerSpringXAnimationTime;
        viewport.centerSpringY.animationTime = oldValues.centerSpringYAnimationTime;
        viewport.zoomSpring.animationTime = oldValues.zoomSpringAnimationTime;
    }

    function adjustRectForPanel(rect) {
        var newRect = jQuery.extend(true, {}, rect);
        var reservedPortion = panelReservedPortion();
        var newWidth = rect.width / (1 - reservedPortion);
        newRect.x = rect.x - (newWidth - rect.width);
        newRect.width = newWidth;
        return newRect;
    }

    function subtractPanelFromViewport(viewportRect) {
        var reservedPortion = panelReservedPortion();
        var newRect = jQuery.extend(true, {}, viewportRect);
        newRect.width = viewportRect.width * (1 - reservedPortion);
        newRect.x = newRect.x + (viewportRect.width - newRect.width);
        return newRect;
    }

    function panelReservedPortion() {
        var overlay = $("#overlayControls");
        var containerWidth = openSeadragonViewer.viewport.getContainerSize().x;
        var panelWidth = overlay.width() +
            parseInt(overlay.css("margin-left")) +
            parseInt(overlay.css("margin-right"));
        return (panelWidth / containerWidth);
    }

    function calcProximateScene(rect) {
        var maxCoverage = 0;
        var maxLi = null;
        $("#storyList > li").each(function(i, li) {
            var rectArea = rect.width * rect.height;
            var story = $(li).find(".story").data("beehive-story");
            var storyRect = new OpenSeadragon.Rect(parseFloat(story.region.x),
                parseFloat(story.region.y),
                parseFloat(story.region.width),
                parseFloat(story.region.height));
            var intersectRect = rectIntersect(rect, storyRect);
            if (intersectRect !== null) {
                var storyArea = storyRect.width * storyRect.height;
                var intersectArea = intersectRect.width * intersectRect.height;
                var storyIntersectPct = intersectArea / storyArea;
                var viewIntersectPct = intersectArea / rectArea;
                var coverage = (1.2 * storyIntersectPct) + viewIntersectPct;
                if (storyIntersectPct > 0.1 && viewIntersectPct > 0.1 && coverage > maxCoverage) {
                    maxCoverage = coverage;
                    maxLi = li;
                }
            }
        });
        return maxLi;
    }

    function rectIntersect(rectA, rectB) {
        var xL = Math.max(rectA.x, rectB.x);
        var xR = Math.min(rectA.x + rectA.width, rectB.x + rectB.width);
        if (xL >= xR) {
            return null;
        }
        var yT = Math.max(rectA.y, rectB.y);
        var yB = Math.min(rectA.y + rectA.height, rectB.y + rectB.height);
        if (yT >= yB) {
            return null;
        }
        return new OpenSeadragon.Rect(xL, yB, xR - xL, yB - yT);
    }

    // Export functions
    window.utils = {
        paramsToHash,
        withSlowOSDAnimation,
        adjustRectForPanel,
        subtractPanelFromViewport,
        panelReservedPortion,
        calcProximateScene,
        rectIntersect
    };
})();
