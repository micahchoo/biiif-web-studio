<?xml version="1.0" encoding="UTF-8"?>
<custom_rules>
  <rule id="iiif-api-1">
    <title>IIIF Image API URI Construction</title>
    <description>Construct IIIF Image API URIs following the standard syntax pattern. The Image API 3.0 uses the format: {scheme}://{server}{/prefix}/{identifier}/{region}/{size}/{rotation}/{quality}.{format}</description>
    <pattern>
      <code>// Example: Full image at maximum size
const imageUri = `${service.id}/full/max/0/default.jpg`;

// Example: Specific region (x,y,w,h)
const croppedUri = `${service.id}/100,200,300,400/200,/0/default.jpg`;

// Example: Square thumbnail
const thumbUri = `${service.id}/square/200,/0/default.jpg`;

// Example: Percentage region
const percentUri = `${service.id}/pct:10,10,80,80/500,/0/default.jpg`;</code>
    </pattern>
    <parameters>
      <param>region: 'full', 'square', 'x,y,w,h', or 'pct:x,y,w,h'</param>
      <param>size: 'max', 'w,', ',h', 'w,h', '^w,h', or '!w,h'</param>
      <param>rotation: '0', '90', '180', '270', or arbitrary degrees</param>
      <param>quality: 'default', 'color', 'gray', or 'bitonal'</param>
      <param>format: 'jpg', 'tif', 'png', 'gif', 'jp2', 'pdf', or 'webp'</param>
    </parameters>
    <note>Always use the @context from http://iiif.io/api/image/3/context.json for Image API services</note>
  </rule>

  <rule id="iiif-api-2">
    <title>Image Service Declaration in Manifests</title>
    <description>Declare IIIF Image API services in the service property of images to enable deep zoom and dynamic sizing.</description>
    <pattern>
      <code>{
  "type": "Image",
  "id": "https://example.org/image1/full/max/0/default.jpg",
  "service": [
    {
      "id": "https://example.org/image1",
      "type": "ImageService3",
      "profile": "level2",  // level0, level1, or level2
      "width": 6000,
      "height": 4000,
      "tiles": [
        {
          "width": 512,
          "scaleFactors": [1, 2, 4, 8]
        }
      ]
    }
  ]
}</code>
    </pattern>
    <profiles>
      <profile>level0: Static images, no dynamic resizing</profile>
      <profile>level1: Basic image requests, size and region</profile>
      <profile>level2: Full functionality including rotation and quality</profile>
    </profiles>
  </rule>

  <rule id="iiif-api-3">
    <title>Content State Encoding and Decoding</title>
    <description>Encode and decode IIIF Content States following the Content State API 1.0 specification. Used for sharing specific views, regions, or annotations.</description>
    <pattern>
      <code>// Encode a content state to base64url
function encodeContentState(state: any): string {
  const json = JSON.stringify(state);
  const encoded = btoa(json)
    .replace(/\+/g, '-')
    .replace(/\//g, '_')
    .replace(/=/g, '');
  return encoded;
}

// Decode a base64url content state
function decodeContentState(encoded: string): any {
  // Add padding if needed
  const padding = '='.repeat((4 - encoded.length % 4) % 4);
  const base64 = encoded
    .replace(/-/g, '+')
    .replace(/_/g, '/') + padding;
  const json = atob(base64);
  return JSON.parse(json);
}

// Example: Content state for a region of a canvas
const contentState = {
  "@context": "http://iiif.io/api/presentation/3/context.json",
  "id": "https://example.org/annotation/1",
  "type": "Annotation",
  "motivation": ["contentState"],
  "target": {
    "id": "https://example.org/manifest/canvas1#xywh=100,200,300,400",
    "type": "Canvas",
    "partOf": [{
      "id": "https://example.org/manifest",
      "type": "Manifest"
    }]
  }
};</code>
    </pattern>
    <note>Content states must have motivation "contentState" and target the resource to be shared</note>
  </rule>

  <rule id="iiif-api-4">
    <title>Content State URL Parameters</title>
    <description>Use the iiif-content parameter to pass content states via URL, supporting HTTP GET, POST, drag-drop, and paste operations.</description>
    <pattern>
      <code>// URL with embedded content state (base64url encoded)
const viewerUrl = `https://viewer.example.org/?iiif-content=${encodeContentState(state)}`;

// URL referencing content state by URI
const referencedUrl = `https://viewer.example.org/?iiif-content=https://example.org/state/123`;

// Handling incoming content state
const params = new URLSearchParams(window.location.search);
const contentStateParam = params.get('iiif-content');

if (contentStateParam) {
  const state = contentStateParam.startsWith('http') 
    ? await fetch(contentStateParam).then(r => r.json())
    : decodeContentState(contentStateParam);
  // Process the content state...
}</code>
    </pattern>
  </rule>

  <rule id="iiif-api-5">
    <title>Search Service Declaration</title>
    <description>Declare Content Search API 2.0 services on IIIF resources to enable text search within annotations.</description>
    <pattern>
      <code>{
  "type": "Manifest",
  "service": [
    {
      "id": "https://example.org/services/manifest1/search",
      "type": "SearchService2",
      "service": [
        {
          "id": "https://example.org/services/manifest1/autocomplete",
          "type": "AutoCompleteService2"
        }
      ]
    }
  ]
}</code>
    </pattern>
    <note>The search service can be associated with Collection, Manifest, Range, or Canvas. Scope is determined by the resource it's attached to.</note>
  </rule>

  <rule id="iiif-api-6">
    <title>Search Query Parameters</title>
    <description>Construct search queries following the Content Search API 2.0 specification.</description>
    <pattern>
      <code>// Basic search
const searchUrl = `${service.id}?q=search+terms`;

// Search with motivation filter
const motivationUrl = `${service.id}?q=bird&motivation=painting`;

// Search with date range (ISO8601 format)
const dateUrl = `${service.id}?q=term&date=2023-01-01T00:00:00Z/2023-12-31T23:59:59Z`;

// Search with user filter
const userUrl = `${service.id}?q=term&user=https://example.org/users/jane`;

// Autocomplete request
const autocompleteUrl = `${autocompleteService.id}?q=par&min=5`;</code>
    </pattern>
    <parameters>
      <param>q: Space-separated search terms (required)</param>
      <param>motivation: Space-separated motivation terms</param>
      <param>date: ISO8601 date ranges (start/end format)</param>
      <param>user: Space-separated user URIs</param>
      <param>min: Minimum occurrences for autocomplete</param>
    </parameters>
  </rule>

  <rule id="iiif-api-7">
    <title>Search Response Handling</title>
    <description>Process Content Search API responses which are AnnotationPages with optional paging and highlighting annotations.</description>
    <pattern>
      <code>interface SearchResult {
  "@context": "http://iiif.io/api/search/2/context.json";
  id: string;
  type: "AnnotationPage";
  partOf?: {  // Present when paged
    id: string;
    type: "AnnotationCollection";
    total: number;
    first: { id: string; type: "AnnotationPage" };
    last: { id: string; type: "AnnotationPage" };
  };
  next?: { id: string; type: "AnnotationPage" };
  prev?: { id: string; type: "AnnotationPage" };
  startIndex?: number;
  items: Annotation[];  // Matching annotations
  annotations?: [{     // Additional info (highlighting, context)
    type: "AnnotationPage";
    items: Annotation[];  // Motivation: "highlighting" or "contextualizing"
  }];
}</code>
    </pattern>
    <note>Match highlighting annotations use motivation "highlighting" with TextQuoteSelector. Match context uses motivation "contextualizing".</note>
  </rule>

  <rule id="iiif-api-8">
    <title>Authorization Flow Services</title>
    <description>Implement IIIF Authorization Flow API 2.0 for access-controlled content. Services are nested: probe → access → (token, logout).</description>
    <pattern>
      <code>{
  "id": "https://example.org/video.mp4",
  "type": "Video",
  "service": [
    {
      "id": "https://example.org/probe/video",
      "type": "AuthProbeService2",
      "service": [
        {
          "id": "https://example.org/login",
          "type": "AuthAccessService2",
          "profile": "active",  // active, kiosk, or external
          "label": { "en": ["Login to Example Institution"] },
          "heading": { "en": ["Please Log In"] },
          "note": { "en": ["Login required to view this content."] },
          "confirmLabel": { "en": ["Login"] },
          "service": [
            {
              "id": "https://example.org/token",
              "type": "AuthAccessTokenService2",
              "errorHeading": { "en": ["Error"] },
              "errorNote": { "en": ["Could not authenticate."] }
            },
            {
              "id": "https://example.org/logout",
              "type": "AuthLogoutService2",
              "label": { "en": ["Logout"] }
            }
          ]
        }
      ]
    }
  ]
}</code>
    </pattern>
    <profiles>
      <profile>active: User interacts with login UI (most common)</profile>
      <profile>kiosk: Automatic authentication (no user interaction)</profile>
      <profile>external: User already has credentials (IP-based, etc.)</profile>
    </profiles>
  </rule>

  <rule id="iiif-api-9">
    <title>Probe Service Response Handling</title>
    <description>Process AuthProbeResult2 responses to determine access status and handle substitutes or redirects.</description>
    <pattern>
      <code>interface AuthProbeResult {
  "@context": "http://iiif.io/api/auth/2/context.json";
  type: "AuthProbeResult2";
  status: number;  // HTTP status code that content would return
  substitute?: [{  // Alternative resources if denied
    id: string;
    type: string;
    label?: LanguageMap;
  }];
  location?: {     // Redirect target (30x status)
    id: string;
    type: string;
  };
  heading?: LanguageMap;  // Error heading if denied
  note?: LanguageMap;     // Error message if denied
}

// Handle probe response
function handleProbeResult(result: AuthProbeResult): void {
  if (result.status === 200) {
    // Access granted - display resource
  } else if (result.status >= 300 && result.status < 400 && result.location) {
    // Redirect to location.id
  } else if (result.status === 401 && result.substitute) {
    // Show substitute resource (tiered access)
  } else {
    // Show error with result.heading and result.note
  }
}</code>
    </pattern>
  </rule>

  <rule id="iiif-api-10">
    <title>Change Discovery Activity Streams</title>
    <description>Implement IIIF Change Discovery API 1.0 using Activity Streams for publishing resource changes.</description>
    <pattern>
      <code>// Ordered Collection (entry point)
const collection = {
  "@context": "http://iiif.io/api/discovery/1/context.json",
  "id": "https://example.org/activity/all-changes",
  "type": "OrderedCollection",
  "totalItems": 21456,
  "rights": "http://creativecommons.org/licenses/by/4.0/",
  "seeAlso": [{
    "id": "https://example.org/dataset/dcat.json",
    "type": "Dataset",
    "label": { "en": ["Dataset Description"] },
    "format": "application/ld+json",
    "profile": "http://www.w3.org/ns/dcat#"
  }],
  "first": { "id": "https://example.org/activity/page-0", "type": "OrderedCollectionPage" },
  "last": { "id": "https://example.org/activity/page-214", "type": "OrderedCollectionPage" }
};

// Activity Types
const activities = {
  Create: "Initial resource creation",
  Update: "Any modification to resource",
  Delete: "Resource deletion or de-publication",
  Move: "Resource republished at new URI",
  Add: "Resource added to stream (aggregation)",
  Remove: "Resource removed from stream",
  Refresh: "Beginning of full state refresh"
};</code>
    </pattern>
  </rule>

  <rule id="iiif-api-11">
    <title>Activity Stream Page Structure</title>
    <description>Structure OrderedCollectionPage with activities ordered from oldest to newest.</description>
    <pattern>
      <code>{
  "@context": "http://iiif.io/api/discovery/1/context.json",
  "id": "https://example.org/activity/page-1",
  "type": "OrderedCollectionPage",
  "startIndex": 20,
  "partOf": {
    "id": "https://example.org/activity/all-changes",
    "type": "OrderedCollection"
  },
  "prev": { "id": "https://example.org/activity/page-0", "type": "OrderedCollectionPage" },
  "next": { "id": "https://example.org/activity/page-2", "type": "OrderedCollectionPage" },
  "orderedItems": [
    {
      "type": "Update",
      "object": {
        "id": "https://example.org/iiif/1/manifest",
        "type": "Manifest",
        "canonical": "https://example.org/iiif/1",
        "seeAlso": [{
          "id": "https://example.org/metadata/1.json",
          "type": "Dataset",
          "format": "application/ld+json"
        }],
        "provider": [{
          "id": "https://example.org/about",
          "type": "Agent",
          "label": { "en": ["Example Organization"] }
        }]
      },
      "endTime": "2017-09-21T00:00:00Z",
      "startTime": "2017-09-20T23:58:00Z",
      "actor": {
        "id": "https://example.org/person/admin1",
        "type": "Person"
      },
      "summary": "admin updated the manifest, fixing reported bug #15."
    }
  ]
}</code>
    </pattern>
    <note>Activities MUST be ordered from earliest to most recent. Clients process backwards from last page.</note>
  </rule>

  <rule id="iiif-api-12">
    <title>Accompanying Canvas Pattern</title>
    <description>Use accompanyingCanvas to provide supplementary content (like a score image with audio, or audio with images) that should be displayed alongside the main content.</description>
    <pattern>
      <code>{
  "type": "Canvas",
  "id": "https://example.org/canvas/audio",
  "duration": 1985.024,
  "accompanyingCanvas": {
    "id": "https://example.org/canvas/accompanying",
    "type": "Canvas",
    "label": { "en": ["Score Page"] },
    "height": 998,
    "width": 772,
    "items": [
      {
        "type": "AnnotationPage",
        "items": [
          {
            "type": "Annotation",
            "motivation": "painting",
            "body": {
              "type": "Image",
              "id": "https://example.org/image.jpg",
              "format": "image/jpeg"
            },
            "target": "https://example.org/canvas/accompanying"
          }
        ]
      }
    ]
  },
  "items": [
    // Main audio content here
  ]
}</code>
    </pattern>
    <restrictions>
      <item>Each accompanyingCanvas can contain only ONE Canvas</item>
      <item>Cannot contain nested accompanyingCanvas or placeholderCanvas</item>
      <item>Target of annotation must be the accompanyingCanvas id, not the parent</item>
      <item>Client decides whether and how to display (optional content)</item>
    </restrictions>
  </rule>

  <rule id="iiif-api-13">
    <title>Placeholder Canvas Pattern</title>
    <description>Use placeholderCanvas to show content before the user chooses to interact with the main content (like a poster image before playing video).</description>
    <pattern>
      <code>{
  "type": "Canvas",
  "id": "https://example.org/canvas/video",
  "width": 1920,
  "height": 1080,
  "duration": 3600,
  "placeholderCanvas": {
    "id": "https://example.org/canvas/poster",
    "type": "Canvas",
    "width": 640,
    "height": 360,
    "items": [
      {
        "type": "AnnotationPage",
        "items": [
          {
            "type": "Annotation",
            "motivation": "painting",
            "body": {
              "type": "Image",
              "id": "https://example.org/poster.jpg",
              "format": "image/jpeg"
            },
            "target": "https://example.org/canvas/poster"
          }
        ]
      }
    ]
  },
  "items": [
    // Main video content here
  ]
}</code>
    </pattern>
    <note>placeholderCanvas is displayed before the main content is activated. Unlike accompanyingCanvas, it's a preview/replacement until interaction.</note>
  </rule>

  <rule id="iiif-api-14">
    <title>Behavior Values</title>
    <description>Use behavior property to suggest how clients should present resources. Behaviors can be set on Collection, Manifest, Canvas, and Range.</description>
    <pattern>
      <code>// Collection/Manifest behaviors
const collectionBehaviors = {
  "auto-advance": "Move to next Canvas when current finishes",
  "continuous": "Canvases form continuous view (scrolling)",
  "facing-pages": "Two Canvases side-by-side (like open book)",
  "individuals": "Each Canvas is distinct object",
  "multi-part": "This is part of larger logical collection",
  "no-auto-advance": "Stay on Canvas when it finishes",
  "paged": "Paged object (books, etc.)",
  "repeat": "Loop back to start at end",
  "sequence": "Default - ordered sequence of Canvases",
  "thumbnail-nav": "Use thumbnails for navigation",
  "together": "All Canvases should be displayed together",
  "unordered": "Order of Canvases is not significant"
};

// Canvas behaviors
const canvasBehaviors = {
  "hidden": "Not shown in navigation",
  "info": "Canvas is information about object (not content)",
  "manga": "Reading direction is right-to-left",
  "non-paged": "Not part of paging sequence",
  "no-auto-advance": "Don't advance automatically",
  "repeat": "Repeat this Canvas"
};

// Range behaviors
const rangeBehaviors = {
  "sequence": "Default - sequence of Canvases",
  "thumbnail": "This Range should be thumbnail",
  "hidden": "Not shown in navigation"
};</code>
    </pattern>
    <note>Behaviors are suggestions to clients, not strict requirements. Multiple behaviors can be combined.</note>
  </rule>

  <rule id="iiif-api-15">
    <title>Viewing Direction</title>
    <description>Set viewingDirection on Manifests and Ranges to indicate reading/presentation order.</description>
    <pattern>
      <code>{
  "type": "Manifest",
  "viewingDirection": "left-to-right",  // Default
  // Other options:
  // "right-to-left" - For right-to-left scripts
  // "top-to-bottom" - Vertical reading
  // "bottom-to-top" - Uncommon
  "items": [...]
}</code>
    </pattern>
  </rule>

  <rule id="iiif-api-16">
    <title>Annotation Target with Fragment Selector</title>
    <description>Target specific regions of Canvases using fragment selectors (xywh for space, t for time).</description>
    <pattern>
      <code>// Spatial region (x, y, width, height)
const spatialTarget = {
  "id": "https://example.org/canvas1#xywh=100,200,300,400",
  "type": "Canvas"
};

// Temporal region (time in seconds)
const temporalTarget = {
  "id": "https://example.org/canvas1#t=30,60",
  "type": "Canvas"
};

// Spatio-temporal region
const spatioTemporalTarget = {
  "id": "https://example.org/canvas1#xywh=100,200,300,400&t=30,60",
  "type": "Canvas"
};

// With partOf for context
const targetWithContext = {
  "id": "https://example.org/canvas1#xywh=100,200,300,400",
  "type": "Canvas",
  "partOf": [{
    "id": "https://example.org/manifest",
    "type": "Manifest",
    "label": { "en": ["Containing Manifest"] }
  }]
};</code>
    </pattern>
  </rule>

  <rule id="iiif-api-17">
    <title>Range Structures (Table of Contents)</title>
    <description>Create hierarchical table of contents using Range resources with nested items.</description>
    <pattern>
      <code>{
  "type": "Manifest",
  "structures": [
    {
      "id": "https://example.org/range/toc",
      "type": "Range",
      "label": { "en": ["Table of Contents"] },
      "items": [
        {
          "id": "https://example.org/range/chapter1",
          "type": "Range",
          "label": { "en": ["Chapter 1"] },
          "items": [
            {
              "id": "https://example.org/canvas/p1",
              "type": "Canvas"
            },
            {
              "id": "https://example.org/canvas/p2",
              "type": "Canvas"
            }
          ]
        },
        {
          "id": "https://example.org/range/chapter2",
          "type": "Range",
          "label": { "en": ["Chapter 2"] },
          "items": [
            {
              "id": "https://example.org/canvas/p1#xywh=0,0,1000,2000",
              "type": "Canvas"
            }
          ]
        }
      ]
    }
  ]
}</code>
    </pattern>
    <note>Ranges can contain other Ranges (hierarchical) or Canvas references (including with selectors). The "supplementary" property can link to annotations about the Range.</note>
  </rule>

  <rule id="iiif-api-18">
    <title>Provider and Agent Pattern</title>
    <description>Use provider property to credit organizations responsible for the resource. Each provider is an Agent with optional homepage, logo, and seeAlso.</description>
    <pattern>
      <code>{
  "type": "Manifest",
  "provider": [
    {
      "id": "https://example.org/about",
      "type": "Agent",
      "label": { "en": ["Example Institution"] },
      "homepage": [
        {
          "id": "https://example.org/",
          "type": "Text",
          "label": { "en": ["Institution Homepage"] },
          "format": "text/html"
        }
      ],
      "logo": [
        {
          "id": "https://example.org/logo.png",
          "type": "Image",
          "format": "image/png",
          "width": 200,
          "height": 100
        }
      ],
      "seeAlso": [
        {
          "id": "https://example.org/about.json",
          "type": "Dataset",
          "format": "application/json",
          "profile": "https://schema.org/"
        }
      ]
    }
  ]
}</code>
    </pattern>
  </rule>

  <rule id="iiif-api-19">
    <title>Required Statement Pattern</title>
    <description>Use requiredStatement for attribution or rights information that must be displayed to users.</description>
    <pattern>
      <code>{
  "type": "Manifest",
  "requiredStatement": {
    "label": { "en": ["Attribution"] },
    "value": { 
      "en": ["Provided by Example Institution. Public Domain."] 
    }
  }
}</code>
    </pattern>
    <note>Unlike metadata, requiredStatement must be displayed by clients. Use for critical attribution or rights.</note>
  </rule>

  <rule id="iiif-api-20">
    <title>Rights and Licensing</title>
    <description>Use rights property to specify license or rights statement URI. This is machine-readable (unlike requiredStatement which is human-readable).</description>
    <pattern>
      <code>{
  "type": "Manifest",
  "rights": "http://creativecommons.org/licenses/by/4.0/"
  // Or: "http://creativecommons.org/publicdomain/mark/1.0/"
  // Or: "http://rightsstatements.org/vocab/NoC-US/1.0/"
}</code>
    </pattern>
    <valid_values>
      <value>Creative Commons licenses (http://creativecommons.org/licenses/...)</value>
      <value>Creative Commons Public Domain Mark (http://creativecommons.org/publicdomain/...)</value>
      <value>RightsStatements.org statements (http://rightsstatements.org/vocab/...)</value>
      <value>Extension mechanism URIs</value>
    </valid_values>
  </rule>
</custom_rules>
